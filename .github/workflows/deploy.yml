name: Deploy to Production Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 31.31.196.170 >> ~/.ssh/known_hosts
        
    - name: Deploy to server
      run: |
        # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å –±–∏–ª–¥–æ–º
        tar -czf build.tar.gz -C build .
        
        # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp build.tar.gz ${{ secrets.REG_LOGIN }}@31.31.196.170:/tmp/
        
        # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh ${{ secrets.REG_LOGIN }}@31.31.196.170 << 'EOF'
          mkdir -p www/ds.ru
          tar -xzf /tmp/build.tar.gz -C www/ds.ru
          rm /tmp/build.tar.gz
          echo "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        EOF
        
    - name: Deploy success notification
      run: |
        echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://31.31.196.170/ds.ru"
